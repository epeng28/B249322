---
title: "Geographical and Monthly Trends of Salbutamol Prescriptions Across Scotland (2024)"
output: 
  html_document:
  theme: flatly
date: "2025-10-31"
---
# Introduction
Salbutamol is a short acting beta agonist which provides acute relief of symptoms of asthma and chronic obstructive pulmonary disease (COPD). It is a widely prescribed drug, thus making it a useful indicator to makes inferences on respiratory health across Scotland. This project aims to explore the monthly and geographical trends in Salbutamol prescribing throughout Scotland in 2024.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(janitor)
library(gt)
library(here)
library(sf)
library(ggspatial)
```

```{r}
# Data wrangling to produce a dataset only featuring data relating to bronchodilator prescriptions in Scotland.

jantojun_2024 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f0df380b-3f9b-4536-bb87-569e189b727a/download/hb_pitc2024_01_06-1.csv") %>% 
  clean_names()

jultodec_2024 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f3b9f2e2-66c0-4310-9b8e-734781d2ed0a/download/hb_pitc2024_07_12-1.csv") %>% 
  clean_names()

# Combine the two datasets into one to cover the full year of 2024
data_2024 <- bind_rows(jantojun_2024, jultodec_2024)

# Read healthboard lookup table
hb_names <- read_csv(here("data", "hb14_hb19 (1).csv")) %>% 
  clean_names()

# Assigns the names of the health boards to its corresponding HBT numeric code by joining with the healthboard lookup table.
data_2024_with_names <- 
  full_join(hb_names, data_2024, by = c("hb" = "hbt")) %>% 
  filter(!is.na(hb_name))

# Filter for bronchodilators only using the BNF code for bronchodilators (0301).
bronchodilators_2024 <- data_2024_with_names %>% 
  filter(str_starts(bnf_item_code, "0301")) %>% 
  select(-hb_date_enacted, -hb_date_archived, -country, -dmd_code)
```

```{r}
# Assessing which bronchodilators are the most widely prescribed.

top5_bronchodilators <- bronchodilators_2024 %>% 
  select(bnf_item_description, number_of_paid_items) %>% 
  group_by(bnf_item_description) %>%
  summarise(paid_items_total = sum(number_of_paid_items)) %>% 
  slice_max(paid_items_total, n = 5)

# Creates a bar chart showing top 5 most prescribed bronchodilators.
count_plot <- top5_bronchodilators %>% 
  ggplot(aes(x= paid_items_total, 
             y= reorder(str_wrap(bnf_item_description, 
                                 width = 30),
                        paid_items_total))) +
  geom_col(fill = "steelblue") +
  labs(title = "Top 5 Most Prescribed Bronchodilators",
       subtitle = "Scotland (2024)",
       x = "Prescriptions Issued", 
       y = "Bronchodilator") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

count_plot
```
Figure 1. Top 5 most commonly prescribed bronchodilators in Scotland (2024). 

Salbutamol-based drugs are dominant in this ranking, with ranks 1, 2 and 5 all representing formulations of Salbutamol. This highlights the wide usage of Salbutamol in Scotland as well as suggesting a high prevelance of asthma and COPD in the country.
```{r}
# Assessing monthly patterns in Salbutamol prescriptions.

# Filters data for only Salbutamol-based drugs, using its BNF code to ensure brand names such as 'Ventolin' are not excluded.
salbutamol <- bronchodilators_2024 %>% 
  filter(str_detect(bnf_item_code, "0301011R0")) 

# Creates a dataset to show number of Salbutamol prescriptions per month. 
salbutamol_monthly <- salbutamol %>% 
# Change 'paid_date_month' into a factor.
  mutate(
    paid_date_month = parse_date_time(paid_date_month, "ym"),
    month = factor(format(paid_date_month, "%B"), 
                   levels = month.name)) %>% 
  group_by(month) %>% 
  summarise(paid_items_total = sum(number_of_paid_items))

# Creates a line graph with trend line.
monthly_plot <- salbutamol_monthly %>% 
  ggplot(aes(x = month, y = paid_items_total, group = 1)) +
  geom_line(colour = "steelblue") +
  geom_point(colour = "#2E5D91", size = 2) +
  geom_smooth(se = FALSE, colour = "#87CEFA", 
              linetype = "dashed", linewidth = 0.5) +
  labs(title = "Salbutamol Prescriptions per Month",
       subtitle = "Scotland (2024)",
       x = "Month", 
       y = "Prescriptions Issued") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 25),
        plot.title = element_text(face = "bold"))

monthly_plot
```
Figure 2. Salbutamol prescriptions per month in Scotland (2024). 

The Trend line shows increase in prescriptions during winter months. This is likely due to an increase in asthma and COPD symptoms during colder weather.

```{r}
# Data wrangling to produce Salbutamol prescriptions data based on population of health boards across Scotland (2024).

# Dataset with population estimates of each healthboard (1981-2024)
hb_population <- read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_03102025.csv") %>% 
  clean_names()

#Filter for only 2024
pop_2024 <- hb_population %>% 
  filter(year == "2024")

# Create dataset with the populations for each healthboard for 2024.
pop_2024_with_names <- 
  full_join(hb_names, pop_2024, by = c("hb" = "hb")) %>% 
  rename(population_2024 = "all_ages") %>% 
  filter(!is.na(hb_name), sex == "All") %>% 
  select(hb_name, population_2024)

# Creates a dataset to show number of prescriptions issued for each healthboard. 
salbutamol_byhb <- salbutamol %>% 
  group_by(hb_name) %>% 
  summarise(paid_items_total = sum(number_of_paid_items)) %>% 
  rename(prescriptions = "paid_items_total")
  
# Add population data and new column for prescriptions per 100k.
salbutamol_pop <- 
  full_join(salbutamol_byhb, pop_2024_with_names, 
                            by = c("hb_name" = "hb_name")) %>% 
  mutate(prescriptions_per_100k 
         = prescriptions/population_2024*100000) %>% 
  arrange(desc(prescriptions)) %>% 
  mutate(Rank = row_number()) %>% 
  select(Rank, hb_name, population_2024, prescriptions, prescriptions_per_100k)
```


```{r}
# Assessing Salbutamol prescriptions trends by health board with a gt table.
table <- salbutamol_pop %>% 
  arrange(desc(prescriptions)) %>% 
  gt() %>% 
  cols_label(hb_name = "Health Board", 
             prescriptions = "Prescriptions Issued", 
             population_2024 = "Population", 
             prescriptions_per_100k = 
               "Prescriptions per 100k") %>% 
  tab_header(title = "Salbutamol Prescriptions Ranked by Health Board",
             subtitle = "Scotland (2024)") %>% 
  fmt_number(columns = c(population_2024, prescriptions, prescriptions_per_100k), decimals = 0) %>% 
  grand_summary_rows(
    columns = c(prescriptions, prescriptions_per_100k), 
                     fns = list("Average"= ~mean(.,na.rm = TRUE)))

table
```
Figure 3. Table ranking total Salbutamol prescriptions by Scottish health board. 

NHS Greater Glasgow and Clyde has the most prescriptions amongt all the healthboards. This is likely due to the large population. Note that with prescriptions per 100k population, many patients will likely have repeat prescriptions.
```{r}
# Assessing Salbutamol prescription trends by NHS health board population by creating a map.

# Read NHS health board shapes for map and add "NHS" in front of HBName to match salbutamol_pop dataset.
map <- 
  st_read(here("data", "Week6_NHS_healthboards_2019.shp")) %>% 
  mutate(HBName = paste0("NHS ", HBName))

# Join with map data.
prescription_mapped <- 
  full_join(map, salbutamol_pop, by = c("HBName" = "hb_name")) %>%   filter(!is.na(HBCode))

# Create map
prescription_map <- prescription_mapped %>% 
  ggplot(aes(fill = prescriptions_per_100k)) +
  geom_sf(colour = "black", size = 0.1) +
  scale_fill_distiller(palette = "Blues", 
                       direction = 1, 
                       name = "Prescriptions per 100k") +
  labs(title = "Salbutamol Prescriptions by NHS Healthboard (2024)", 
       subtitle = "Rate per 100k people") +
  theme_void() +
  theme(plot.title = element_text(face = "bold"), 
        legend.title = element_text(size = 10))

prescription_map
```
Figure 4.   Rates of Salbutamol prescriptions per 100k people across Scottish health boards in 2024.

Rates are highest per 100k across areas such as Dumfries and Galloway and Lanarkshire, and lowest in areas such as Shetland and Orkney. Potential factors may be due to better air quality in Shetland and Orkney, or differing prescribing patterns amongst different health boards.

